(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(a){if(a.ep)return;a.ep=!0;const i=o(a);fetch(a.href,i)}})();const G={extinguisher:"M16,10h2V6h-2V10z M19,4h-2V2h-2v2h-2V2h-2v2h-2V2H9v2H7v10.1c0,1.6,1.3,2.9,2.9,2.9h0.2c1.6,0,2.9-1.3,2.9-2.9 V14h2v2.1c0,1.6,1.3,2.9,2.9,2.9h0.2c1.6,0,2.9-1.3,2.9-2.9V4z",entrance:"M19,19V5c0-1.1-0.9-2-2-2H7C5.9,5,5,5.9,5,7v12H3v-2h2V7h10v10h2v2H19z M13,13h-2v-2h2V13z",default:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"},J={default:{fill:"rgba(127, 140, 141, 0.3)",stroke:"#7f8c8d"},room:{fill:"rgba(52, 152, 219, 0.3)",stroke:"#2980b9"},office:{fill:"rgba(26, 188, 156, 0.3)",stroke:"#16a085"},hall:{fill:"rgba(241, 196, 15, 0.3)",stroke:"#f39c12"},toiletArea:{fill:"rgba(155, 89, 182, 0.3)",stroke:"#8e44ad"},storage:{fill:"rgba(230, 126, 34, 0.3)",stroke:"#d35400"}},E="#e74c3c";function L(n){if(!e.isGridVisible||!e.isSnapEnabled)return n;const t=e.gridSize;return{x:Math.round(n.x/t)*t,y:Math.round(n.y/t)*t}}function H(n){const t=n.coordinates[0];let[o,r]=t[0],[a,i]=t[0];for(const[l,c]of t)l<o&&(o=l),c<r&&(r=c),l>a&&(a=l),c>i&&(i=c);return{x:o,y:r,width:a-o,height:i-r}}function ce(n,t){const o=H(t);if(n.x<o.x||n.x>o.x+o.width||n.y<o.y||n.y>o.y+o.height)return!1;let r=!1;const a=t.coordinates[0];for(let i=0,l=a.length-1;i<a.length;l=i++){const[c,u]=a[i],[d,g]=a[l];u>n.y!=g>n.y&&n.x<(d-c)*(n.y-u)/(g-u)+c&&(r=!r)}return r}function X(n,t,o,r=20){const a=[];for(let i=0;i<=r;i++){const l=i/r,c=Math.pow(1-l,2)*n.x+2*(1-l)*l*o.x+Math.pow(l,2)*t.x,u=Math.pow(1-l,2)*n.y+2*(1-l)*l*o.y+Math.pow(l,2)*t.y;a.push([c,u])}return a}let v,s,x,f,w,m;function de(){v=document.getElementById("canvas"),s=v.getContext("2d"),x=document.getElementById("ruler-top"),f=x.getContext("2d"),w=document.getElementById("ruler-left"),m=w.getContext("2d")}function p(){if(s){if(x.width=v.parentElement.clientWidth,w.height=v.parentElement.clientHeight,s.clearRect(0,0,v.width,v.height),pe(),s.save(),s.translate(e.pan.x,e.pan.y),s.scale(e.scale,e.scale),e.activeFloorId){const n=e.cachedFloorPlanImages[e.activeFloorId];n&&s.drawImage(n,0,0),e.isGridVisible&&ue(),e.project.features.filter(o=>o.properties.floor===e.activeFloorId&&e.visibleLayers[o.properties.type]).forEach(o=>{const r=o.properties.id===e.selectedFeatureId;switch(s.lineWidth=(r?3:2)/e.scale,o.geometry.type){case"Polygon":me(o,r);break;case"Point":ge(o,r);break;case"LineString":_(o,r);break}})}e.tempShape&&(e.currentMode==="area"&&ye(),e.currentMode==="path"&&ve(),e.currentMode==="line"&&be(),e.currentMode==="polygon"&&Se(),e.currentMode==="arc"&&Ee()),s.restore(),e.isShiftPressed&&Ie(),fe()}}function pe(){f.clearRect(0,0,x.width,x.height),m.clearRect(0,0,w.width,w.height),f.font="10px sans-serif",m.font="10px sans-serif",f.fillStyle="#333",m.fillStyle="#333",f.strokeStyle="#ccc",m.strokeStyle="#ccc";const{scale:n,pan:t}=e,o=n>1.5?50:n<.4?200:100;for(let i=0;i<x.width;i+=10){const l=(i-t.x)/n,c=Math.round(l)%o<1;f.beginPath(),f.moveTo(i+.5,c?15:22),f.lineTo(i+.5,30),f.stroke(),c&&i>0&&f.fillText(String(Math.round(l)),i+2,12)}for(let i=0;i<w.height;i+=10){const l=(i-t.y)/n,c=Math.round(l)%o<1;m.beginPath(),m.moveTo(c?15:22,i+.5),m.lineTo(30,i+.5),m.stroke(),c&&i>0&&m.fillText(String(Math.round(l)),2,i+10)}const{x:r,y:a}=e.mousePosScreen;f.fillStyle="rgba(255,0,0,0.7)",m.fillStyle="rgba(255,0,0,0.7)",f.beginPath(),f.moveTo(r,0),f.lineTo(r-3,5),f.lineTo(r+3,5),f.closePath(),f.fill(),m.beginPath(),m.moveTo(0,a),m.lineTo(5,a-3),m.lineTo(5,a+3),m.closePath(),m.fill()}function ue(){const{scale:n,pan:t,gridSize:o}=e;s.strokeStyle="rgba(0,0,0,0.15)",s.lineWidth=1/n;const r=-t.x/n,a=-t.y/n,i=(v.width-t.x)/n,l=(v.height-t.y)/n,c=Math.floor(r/o)*o,u=Math.floor(a/o)*o;for(let d=c;d<i;d+=o)s.beginPath(),s.moveTo(d,a),s.lineTo(d,l),s.stroke();for(let d=u;d<l;d+=o)s.beginPath(),s.moveTo(r,d),s.lineTo(i,d),s.stroke()}function fe(){const{x:n,y:t}=e.mousePosScreen;s.strokeStyle="rgba(100, 100, 100, 0.7)",s.lineWidth=1,s.beginPath(),s.moveTo(0,t+.5),s.lineTo(v.width,t+.5),s.moveTo(n+.5,0),s.lineTo(n+.5,v.height),s.stroke()}function me(n,t){const{subType:o,label:r}=n.properties,a=J[o]||J.default,i=n.geometry.coordinates[0];s.fillStyle=a.fill,s.strokeStyle=t?E:a.stroke,s.beginPath(),s.moveTo(i[0][0],i[0][1]);for(let c=1;c<i.length;c++)s.lineTo(i[c][0],i[c][1]);s.closePath(),s.fill(),s.stroke();const l=H(n.geometry);s.fillStyle=a.stroke,s.font=`bold ${14/e.scale}px sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(r,l.x+l.width/2,l.y+l.height/2)}function he(n,t,o,r){const a=new Path2D(n);s.save(),s.translate(t,o),s.scale(1/e.scale,1/e.scale),s.translate(-12,-12),s.fillStyle=r?E:"#34495e",s.fill(a),s.restore()}function ge(n,t){const[o,r]=n.geometry.coordinates,{subType:a,label:i}=n.properties,l=G[a]||G.default;t&&(s.fillStyle="rgba(231, 76, 60, 0.3)",s.beginPath(),s.arc(o,r,18/e.scale,0,2*Math.PI),s.fill()),he(l,o,r,t),s.fillStyle=t?E:"#34495e",s.font=`${12/e.scale}px sans-serif`,s.textAlign="center",s.fillText(i,o,r-22/e.scale)}function _(n,t){const{coordinates:o}=n.geometry;o.length<2||(s.beginPath(),s.moveTo(o[0][0],o[0][1]),o.slice(1).forEach(r=>s.lineTo(r[0],r[1])),s.strokeStyle=t?E:n.properties.isAccessible?"#3498db":"#f1c40f",s.lineWidth=(t?6:4)/e.scale,s.lineCap="round",s.stroke(),o.forEach(([r,a])=>{s.beginPath(),s.arc(r,a,5/e.scale,0,2*Math.PI),s.fillStyle="#fff",s.fill()}))}function ye(){if(!e.tempShape?.start)return;s.strokeStyle=E,s.lineWidth=1.5/e.scale,s.setLineDash([6/e.scale,6/e.scale]);const{start:n}=e.tempShape,t=L(e.mousePos);s.strokeRect(n.x,n.y,t.x-n.x,t.y-n.y),s.setLineDash([])}function ve(){if(!e.tempShape?.nodes||e.tempShape.nodes.length===0)return;const n=L(e.mousePos),t=[...e.tempShape.nodes.map(o=>[o.x,o.y]),[n.x,n.y]];_({geometry:{type:"LineString",coordinates:t},properties:{isAccessible:document.getElementById("accessiblePath").checked}},!0)}function be(){if(!e.tempShape?.start)return;s.strokeStyle=E,s.lineWidth=2/e.scale,s.beginPath(),s.moveTo(e.tempShape.start.x,e.tempShape.start.y);const n=L(e.mousePos);s.lineTo(n.x,n.y),s.stroke()}function Se(){if(!e.tempShape?.nodes||e.tempShape.nodes.length===0)return;s.strokeStyle=E,s.lineWidth=2/e.scale,s.beginPath();const n=e.tempShape.nodes[0];s.moveTo(n.x,n.y);for(let o=1;o<e.tempShape.nodes.length;o++)s.lineTo(e.tempShape.nodes[o].x,e.tempShape.nodes[o].y);const t=L(e.mousePos);s.lineTo(t.x,t.y),s.stroke()}function Ee(){if(!e.tempShape?.start)return;const n=L(e.mousePos);if(s.strokeStyle=E,s.lineWidth=2/e.scale,s.setLineDash([6/e.scale,6/e.scale]),s.beginPath(),!e.tempShape.control)s.moveTo(e.tempShape.start.x,e.tempShape.start.y),s.lineTo(n.x,n.y);else{const t=X(e.tempShape.start,n,e.tempShape.control);s.moveTo(t[0][0],t[0][1]);for(let o=1;o<t.length;o++)s.lineTo(t[o][0],t[o][1])}s.stroke(),s.setLineDash([])}function Ie(){const{x:r,y:a}=e.mousePosScreen;s.save(),s.beginPath(),s.arc(r,a,75,0,Math.PI*2),s.strokeStyle="#333",s.lineWidth=3,s.stroke(),s.clip(),s.drawImage(v,r-75/2.5,a-75/2.5,150/2.5,150/2.5,r-75,a-75,150,150),s.restore()}function ke(){q(!1),document.getElementById("mode-area")?.click()}function q(n=!0){if(n&&!confirm("Möchten Sie wirklich ein neues Projekt starten? Nicht gespeicherte Änderungen gehen verloren."))return;e.project.type="FeatureCollection",e.project.features=[],e.project.properties={projectName:"Unbenanntes Projekt"},e.project.floorplanImages={};const t=document.getElementById("projectName");t.value=e.project.properties.projectName,e.cachedFloorPlanImages={},Z(),K("EG",!1),B(),I(),k()}function K(n,t=!0){if(!n||n.trim()===""){alert("Der Etagenname darf nicht leer sein.");return}const o=n.trim();if(N().includes(o)){alert("Dieser Etagenname ist bereits vergeben.");return}e.activeFloorId=o,e.project.floorplanImages||(e.project.floorplanImages={}),e.project.floorplanImages[e.activeFloorId]=null,t&&B(),O(),I(),k(),p()}function N(){const n=new Set;return e.project.features.forEach(t=>n.add(t.properties.floor)),e.project.floorplanImages&&Object.keys(e.project.floorplanImages).forEach(t=>n.add(t)),Array.from(n).sort()}function O(){const n=N(),t=e.activeFloorId,o=document.getElementById("floor-select");if(o.innerHTML="",n.length===0){const a=document.createElement("option");a.textContent="Keine Etagen",o.appendChild(a),e.activeFloorId=null}else n.forEach(a=>{const i=document.createElement("option");i.value=a,i.textContent=a,o.appendChild(i)}),t&&n.includes(t)?o.value=t:(e.activeFloorId=n[0],o.value=n[0]);const r=document.getElementById("floor-preview");r&&e.activeFloorId&&e.cachedFloorPlanImages[e.activeFloorId]?(r.src=e.cachedFloorPlanImages[e.activeFloorId].src,r.style.display="block"):r&&(r.style.display="none")}function j(n,t){e.project.features.push({type:"Feature",geometry:n,properties:t}),B(),I(),k()}function Pe(){if(!e.selectedFeatureId){alert("Kein Element zum Löschen ausgewählt.");return}confirm("Möchten Sie das ausgewählte Element wirklich löschen?")&&(e.project.features=e.project.features.filter(n=>n.properties.id!==e.selectedFeatureId),e.selectedFeatureId=null,document.getElementById("deleteBtn").disabled=!0,B(),I(),k(),p())}function U(n){e.project.properties.projectName=n.trim(),I(),k();const t=new Blob([JSON.stringify(e.project,null,2)],{type:"application/geo+json"}),o=document.createElement("a");o.href=URL.createObjectURL(t);const r=(e.project.properties.projectName||"projekt").replace(/[^a-z0-9]/gi,"_").toLowerCase();o.download=`${r}.geojson`,o.click(),URL.revokeObjectURL(o.href)}function xe(n){const t=new FileReader;t.onload=o=>{try{const r=JSON.parse(o.target?.result);Z(),R(r),B()}catch(r){alert("Fehler beim Laden der Projektdatei."),console.error(r)}},t.readAsText(n)}function R(n){if(n.type!=="FeatureCollection"||!n.features)throw new Error("Ungültiges GeoJSON-Projektformat.");e.project=n;const t=document.getElementById("projectName");t.value=e.project.properties.projectName||"",e.cachedFloorPlanImages={},e.project.floorplanImages&&Object.entries(e.project.floorplanImages).forEach(([r,a])=>{if(a){const i=new Image;i.onload=()=>{e.cachedFloorPlanImages[r]=i,r===e.activeFloorId&&p()},i.src=a}});const o=N();e.activeFloorId=o.includes(e.activeFloorId)?e.activeFloorId:o[0]||null,O(),I(),k(),p()}function we(n){if(!e.activeFloorId)return;const t=new FileReader;t.onload=o=>{const r=o.target?.result;e.project.floorplanImages||(e.project.floorplanImages={});const a=e.activeFloorId;e.project.floorplanImages[a]=r;const i=new Image;i.onload=()=>{e.cachedFloorPlanImages[a]=i,B(),O(),p()},i.src=r},t.readAsDataURL(n)}function Le(){return{type:"FeatureCollection",features:[],properties:{projectName:"Unbenanntes Projekt"},floorplanImages:{}}}const e={project:Le(),activeFloorId:null,currentMode:"area",tempShape:null,mousePos:{x:0,y:0},mousePosScreen:{x:0,y:0},gridSize:20,isGridVisible:!0,isSnapEnabled:!0,selectedFeatureId:null,cachedFloorPlanImages:{},isShiftPressed:!1,scale:1,pan:{x:0,y:0},isPanning:!1,panStart:{x:0,y:0},visibleLayers:{area:!0,path:!0,point:!0,connector:!0}},P=[];let b=-1;function B(){b<P.length-1&&P.splice(b+1),P.push(JSON.parse(JSON.stringify(e.project))),b++}function Y(){b>0&&(b--,R(JSON.parse(JSON.stringify(P[b]))))}function W(){b<P.length-1&&(b++,R(JSON.parse(JSON.stringify(P[b]))))}function Z(){P.length=0,b=-1}function je(n,t){const o=document.getElementById(t);if(!o){console.error(`Container mit der ID "${t}" nicht gefunden.`);return}o.innerHTML="";const r="http://www.w3.org/2000/svg",a=document.createElementNS(r,"svg");a.setAttribute("width","100%"),a.setAttribute("height","100%"),a.setAttribute("viewBox","0 0 1200 1000"),a.style.backgroundColor="#f9f9f9";const i={};n.features.forEach(u=>{const d=u.properties.floor;i[d]||(i[d]=[]),i[d].push(u)});let l=0;const c=30;Object.values(i).reverse().forEach(u=>{const d=document.createElementNS(r,"g");d.setAttribute("transform",`translate(${c*l/150}, ${l})`),u.forEach(g=>{if(g.geometry.type==="Polygon"){const ae=g.geometry.coordinates[0].map(le=>le.join(",")).join(" "),z=document.createElementNS(r,"polygon");z.setAttribute("points",ae),z.setAttribute("fill","rgba(17,63,103,0.2)"),z.setAttribute("stroke","#113F67"),d.appendChild(z)}}),a.appendChild(d),l+=150}),o.appendChild(a)}let F=null;function Be(){const n=document.getElementById("file-menu-trigger"),t=document.getElementById("output-menu-trigger"),o=document.getElementById("overview-menu-trigger"),r=document.getElementById("backstage-panel"),a=document.getElementById("backstage-close-btn"),i=document.getElementById("backstage-title"),l=document.getElementById("backstage-file-content"),c=document.getElementById("backstage-output-content"),u=document.getElementById("backstage-overview-content");if(!n||!t||!o||!r){console.error("Menü-Elemente konnten nicht gefunden werden!");return}const d=h=>{l.style.display="none",c.style.display="none",u.style.display="none",h==="file"?(l.style.display="block",i.textContent="Datei"):h==="output"?(c.style.display="block",i.textContent="Ausgabe"):h==="overview"&&(u.style.display="block",i.textContent="Projektübersicht"),r.classList.add("visible"),document.body.classList.add("backstage-visible"),F=h,n.classList.remove("active"),t.classList.remove("active"),o.classList.remove("active"),document.getElementById(`${h}-menu-trigger`)?.classList.add("active")},g=()=>{r.classList.remove("visible"),document.body.classList.remove("backstage-visible"),F=null,n.classList.remove("active"),t.classList.remove("active"),o.classList.remove("active")};n.addEventListener("click",h=>{h.stopPropagation(),F==="file"?g():d("file")}),t.addEventListener("click",h=>{h.stopPropagation(),F==="output"?g():d("output")}),o.addEventListener("click",h=>{h.stopPropagation(),F==="overview"?g():d("overview")}),a.addEventListener("click",g)}let y,$,T,S,C,Q,ee,te,ne,A,D,V,oe,M,re,se;function Fe(){Te(),de(),Je(),Be(),I(),k()}function I(){const n=document.getElementById("overview-stats-panel");if(!n)return;const t=e.project.properties.projectName||"Unbenannt",o=N(),r=o.length,a=e.project.features.filter(l=>l.properties.type==="area").length;let i=`
        <div><span>Projekt:</span><span class="value">${t}</span></div>
        <div><span>Etagen gesamt:</span><span class="value">${r}</span></div>
        <div><span>Flächen/Räume:</span><span class="value">${a}</span></div>
    `;r>0&&o.forEach(l=>{const c=e.project.features.filter(d=>d.properties.floor===l&&d.properties.type==="area").length,u=e.project.features.filter(d=>d.properties.floor===l&&(d.properties.type==="point"||d.properties.type==="connector")).length;i+=`
                <div class="floor-detail">
                    <span>- ${l}:</span>
                    <span class="value">${c} Räume, ${u} Elem.</span>
                </div>
            `}),n.innerHTML=i}function k(){const n=document.getElementById("live-geojson-output");n&&(n.textContent=JSON.stringify(e.project,null,2))}function Te(){y=document.getElementById("canvas"),$=document.getElementById("floor-select"),T=document.getElementById("projectName"),S=document.getElementById("element-type-select"),C=document.getElementById("deleteBtn"),Q=document.getElementById("element-options"),ee=document.getElementById("path-options"),te=document.getElementById("finishPathBtn"),ne=document.getElementById("accessiblePath"),A=document.getElementById("gridSizeInput"),D=document.getElementById("toggleGridBtn"),V=document.getElementById("toggleSnapBtn"),oe=document.getElementById("corner-box"),M=document.getElementById("info-modal"),re=document.getElementById("info-modal-close-btn"),se=M.querySelector(".modal-overlay")}function ie(n){return{x:(n.x-e.pan.x)/e.scale,y:(n.y-e.pan.y)/e.scale}}function Ce(n){n.preventDefault();const t=.1,o=e.scale,r={x:n.offsetX,y:n.offsetY},a=n.deltaY<0?o*(1+t):o/(1+t);e.scale=Math.max(.1,Math.min(a,10));const i=r.x-(r.x-e.pan.x)/o*e.scale,l=r.y-(r.y-e.pan.y)/o*e.scale;e.pan={x:i,y:l},e.mousePosScreen={x:n.offsetX,y:n.offsetY},e.mousePos=ie(e.mousePosScreen),p()}function Me(n){if(!e.activeFloorId){alert("Bitte zuerst eine Etage erstellen oder auswählen.");return}const t=L(n);switch(e.currentMode){case"area":Ne(t);break;case"point":ze(t);break;case"path":Oe(t);break;case"line":$e(t);break;case"polygon":Ae(t);break;case"arc":De(t);break;case"select":Ge(n);break}p()}function Ne(n){if(!e.tempShape)e.tempShape={start:n};else{const{start:t}=e.tempShape,o=Math.min(t.x,n.x),r=Math.min(t.y,n.y),a=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);if(a<e.gridSize/2||i<e.gridSize/2){e.tempShape=null;return}const l=S.value,c=`${l.charAt(0).toUpperCase()+l.slice(1)} ${e.project.features.filter(h=>h.properties.subType===l).length+1}`,u=prompt(`Bezeichnung für '${l}':`,c);if(!u){e.tempShape=null;return}const d=[[[o,r],[o+a,r],[o+a,r+i],[o,r+i],[o,r]]],g={id:`F_${Date.now()}`,floor:e.activeFloorId,type:"area",subType:l,label:u};j({type:"Polygon",coordinates:d},g),e.tempShape=null}}function ze(n){const t=S.selectedOptions[0],o=t.dataset.type,r=t.value,a=`${r.charAt(0).toUpperCase()+r.slice(1)} ${e.project.features.filter(c=>c.properties.subType===r).length+1}`,i=prompt(`Bezeichnung für '${r}':`,a);if(!i)return;const l={id:`F_${Date.now()}`,floor:e.activeFloorId,type:o,subType:r,label:i};if(o==="connector"){const c=prompt("ID des verbundenen Elements (optional):");c&&(l.linksTo={floor:"",connectorId:c.trim()})}j({type:"Point",coordinates:[n.x,n.y]},l)}function Oe(n){e.tempShape||(e.tempShape={nodes:[]}),e.tempShape.nodes.push(n)}function $e(n){if(!e.tempShape)e.tempShape={start:n};else{const t=`Linie ${e.project.features.filter(i=>i.properties.subType==="line").length+1}`,o=prompt("Bezeichnung:",t);if(!o){e.tempShape=null;return}const r={id:`F_${Date.now()}`,floor:e.activeFloorId,type:"path",subType:"line",label:o},a=[[e.tempShape.start.x,e.tempShape.start.y],[n.x,n.y]];j({type:"LineString",coordinates:a},r),e.tempShape=null}}function Ae(n){e.tempShape||(e.tempShape={nodes:[]}),e.tempShape.nodes.push(n)}function De(n){if(!e.tempShape)e.tempShape={start:n};else if(!e.tempShape.control)e.tempShape.control=n;else{const t=`Bogen ${e.project.features.filter(i=>i.properties.subType==="arc").length+1}`,o=prompt("Bezeichnung:",t);if(!o){e.tempShape=null;return}const r={id:`F_${Date.now()}`,floor:e.activeFloorId,type:"path",subType:"arc",label:o},a=X(e.tempShape.start,n,e.tempShape.control);j({type:"LineString",coordinates:a},r),e.tempShape=null}}function Ve(){if(!e.activeFloorId||!e.tempShape?.nodes||e.tempShape.nodes.length<2)return;const n=`Weg ${e.project.features.filter(a=>a.properties.type==="path").length+1}`,t=prompt("Bezeichnung:",n);if(!t){e.tempShape=null,p();return}const o={id:`F_${Date.now()}`,floor:e.activeFloorId,type:"path",subType:"path",label:t,isAccessible:ne.checked},r=e.tempShape.nodes.map(a=>[a.x,a.y]);j({type:"LineString",coordinates:r},o),e.tempShape=null}function Re(){if(!e.activeFloorId||!e.tempShape?.nodes||e.tempShape.nodes.length<3){e.tempShape=null,p();return}const n=S.value,t=`${n.charAt(0).toUpperCase()+n.slice(1)} ${e.project.features.filter(i=>i.properties.subType===n).length+1}`,o=prompt(`Bezeichnung für '${n}':`,t);if(!o){e.tempShape=null,p();return}const r={id:`F_${Date.now()}`,floor:e.activeFloorId,type:"area",subType:n,label:o},a=[...e.tempShape.nodes.map(i=>[i.x,i.y]),[e.tempShape.nodes[0].x,e.tempShape.nodes[0].y]];j({type:"Polygon",coordinates:[a]},r),e.tempShape=null,p()}function Ge(n){const t=e.project.features.filter(r=>r.properties.floor===e.activeFloorId);let o=null;for(const r of[...t].reverse()){if(r.geometry.type==="Polygon"&&ce(n,r.geometry)){o=r.properties.id;break}if(r.geometry.type==="Point"){const[a,i]=r.geometry.coordinates;if(Math.sqrt((n.x-a)**2+(n.y-i)**2)*e.scale<15){o=r.properties.id;break}}}e.selectedFeatureId=o,C.disabled=!e.selectedFeatureId,p()}function Je(){const n=t=>{if(!e.isPanning)return;const o=t.clientX-e.panStart.x,r=t.clientY-e.panStart.y;e.pan.x+=o,e.pan.y+=r,e.panStart={x:t.clientX,y:t.clientY},p()};y.addEventListener("mousemove",t=>{const o=y.getBoundingClientRect();if(e.mousePosScreen={x:t.clientX-o.left,y:t.clientY-o.top},e.mousePos=ie(e.mousePosScreen),e.isPanning){n(t);return}p()}),y.addEventListener("mousedown",t=>{t.button===1&&(t.preventDefault(),e.isPanning=!0,e.panStart={x:t.clientX,y:t.clientY},y.style.cursor="grabbing")}),y.addEventListener("mouseup",t=>{t.button===1&&e.isPanning&&(e.isPanning=!1,y.style.cursor="none")}),y.addEventListener("click",t=>{t.button!==1&&Me(e.mousePos)}),y.addEventListener("wheel",Ce,{passive:!1}),y.addEventListener("mouseleave",()=>{e.isPanning&&(e.isPanning=!1,y.style.cursor="none")}),y.addEventListener("dblclick",()=>{e.currentMode==="polygon"&&Re()}),oe.addEventListener("dblclick",()=>{e.scale=1,e.pan={x:0,y:0},p()}),T.addEventListener("input",()=>{e.project.properties.projectName=T.value,I(),k()}),document.getElementById("newProjectBtn").addEventListener("click",()=>q(!0)),document.getElementById("saveProjectBtn").addEventListener("click",()=>U(T.value)),document.getElementById("exportGeoJsonBtn").addEventListener("click",()=>U(T.value)),document.getElementById("loadProjectInput").addEventListener("change",t=>{const o=t.target.files?.[0];o&&xe(o),t.target.value=""}),document.getElementById("showGeoJsonBtn").addEventListener("click",()=>{const t=document.getElementById("live-geojson-output"),o=document.getElementById("showGeoJsonBtn"),r=t.style.display==="block";t.style.display=r?"none":"block",o.querySelector("span").textContent=r?"Live Code anzeigen":"Code ausblenden"}),document.getElementById("addFloorBtn").addEventListener("click",()=>{const o=`Etage ${N().length+1}`,r=prompt("Name der neuen Etage:",o);r&&K(r)}),$.addEventListener("change",()=>{e.activeFloorId=$.value,e.selectedFeatureId=null,C.disabled=!0,O(),p()}),document.getElementById("floorplanInput").addEventListener("change",t=>{const o=t.target.files?.[0];o&&we(o),t.target.value=""}),document.getElementById("undoBtn").addEventListener("click",Y),document.getElementById("redoBtn").addEventListener("click",W),C.addEventListener("click",Pe),["select","area","point","path","line","polygon","arc"].forEach(t=>{const o=document.getElementById(`mode-${t}`);o.addEventListener("click",()=>{e.currentMode=t,e.tempShape=null,e.selectedFeatureId=null,document.querySelectorAll(".tool-btn").forEach(r=>r.classList.remove("active")),o.classList.add("active"),Q.style.display=t==="area"||t==="point"||t==="polygon"?"block":"none",ee.style.display=t==="path"?"block":"none",C.disabled=!0,(t==="area"||t==="polygon")&&(S.value=S.querySelector('option[data-type="area"]').value),t==="point"&&(S.value=S.querySelector('option[data-type="point"]').value),p()})}),te.addEventListener("click",Ve),document.getElementById("show3DViewBtn").addEventListener("click",()=>{const t=document.getElementById("floor3DView"),o=t.style.display==="block";t.style.display=o?"none":"block",o||je(e.project,"floor3DView")}),D.addEventListener("change",()=>{e.isGridVisible=D.checked,p()}),V.addEventListener("change",()=>{e.isSnapEnabled=V.checked}),A.addEventListener("input",()=>{const t=parseInt(A.value,10);!isNaN(t)&&t>=5&&(e.gridSize=t,p())}),document.querySelectorAll(".layer-toggle").forEach(t=>{t.addEventListener("change",o=>{const r=o.target,a=r.dataset.layer,i=r.checked;a&&(e.visibleLayers[a]=i,a==="point"&&(e.visibleLayers.connector=i),a==="area"&&(e.visibleLayers.connector=i),p())})}),document.getElementById("Einleitung").addEventListener("click",()=>{M.classList.remove("hidden")}),re.addEventListener("click",()=>{M.classList.add("hidden")}),se.addEventListener("click",()=>{M.classList.add("hidden")}),window.addEventListener("keydown",t=>{if(t.key==="Escape"&&e.tempShape&&(e.tempShape=null,p()),t.key==="Shift"&&!e.isShiftPressed&&(e.isShiftPressed=!0,p()),t.ctrlKey||t.metaKey)switch(t.key.toLowerCase()){case"z":t.preventDefault(),Y();break;case"y":t.preventDefault(),W();break}}),window.addEventListener("keyup",t=>{t.key==="Shift"&&(e.isShiftPressed=!1,p())}),document.querySelectorAll(".toolbar-header").forEach(t=>{t.addEventListener("click",()=>{t.classList.toggle("collapsed")})})}function Ue(){Fe(),ke()}window.addEventListener("DOMContentLoaded",Ue);
